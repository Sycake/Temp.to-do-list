<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºŒæœˆ To-Do List (Firebase)</title>
  
  <!-- å¤–éƒ¨æ ·å¼è¡¨ -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>ğŸ“… 2æœˆ To-Do List (Firebase)</h1>
  
  <div class="todo-container">
    <label for="date">é¸æ“‡æ—¥æœŸï¼š</label>
    <select id="date">
      <option value="feb26">2æœˆ26æ—¥</option>
      <option value="feb27">2æœˆ27æ—¥</option>
      <option value="feb28">2æœˆ28æ—¥</option>
    </select>
    
    <br><br>
    <input type="text" id="taskInput" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …">
    <button id="addBtn">æ–°å¢</button>
    
    <ul id="todoList"></ul>
  </div>

  <!-- ä½¿ç”¨ ES Modules çš„æ–¹å¼åŠ è½½ Firebase SDK -->
  <script type="module">
    // 1. å¯¼å…¥ Firebase æ‰€éœ€æ¨¡å—
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    // 2. Firebase é…ç½®ï¼ˆä½¿ç”¨ä½ è‡ªå·±çš„é¡¹ç›®ä¿¡æ¯ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBWZzgBQul9MWpVfp3jl4jwCee-DX1zb0s",
      authDomain: "temp-todo-list-7c25e.firebaseapp.com",
      projectId: "temp-todo-list-7c25e",
      storageBucket: "temp-todo-list-7c25e.firebasestorage.app",
      messagingSenderId: "388844458714",
      appId: "1:388844458714:web:5e9620d9d15c87458c0be3"
    };

    // 3. åˆå§‹åŒ– Firebase å’Œ Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 4. è·å–é¡µé¢å…ƒç´ 
    const dateSelect = document.getElementById("date");
    const taskInput = document.getElementById("taskInput");
    const addBtn = document.getElementById("addBtn");
    const todoList = document.getElementById("todoList");

    // 5. é¡µé¢åŠ è½½å & æ—¥æœŸåˆ‡æ¢æ—¶ï¼ŒåŠ è½½å¯¹åº”æ—¥æœŸçš„ä»»åŠ¡
    document.addEventListener("DOMContentLoaded", () => {
      dateSelect.addEventListener("change", loadTasks);
      addBtn.addEventListener("click", addTask);
      loadTasks(); // é»˜è®¤åŠ è½½å½“å‰ä¸‹æ‹‰æ¡†é€‰å®šæ—¥æœŸçš„ä»»åŠ¡
    });

    // 6. è¯»å–ä»»åŠ¡åˆ—è¡¨ï¼ˆä»æŒ‡å®šæ—¥æœŸæ–‡æ¡£çš„ "tasks" å­é›†åˆï¼‰
    async function loadTasks() {
      const selectedDate = dateSelect.value;
      todoList.innerHTML = ""; // æ¸…ç©ºåˆ—è¡¨

      // Firestore è·¯å¾„ï¼šdates -> selectedDate -> tasks
      const tasksCollection = collection(db, "dates", selectedDate, "tasks");
      const q = query(tasksCollection, orderBy("timestamp", "asc"));

      try {
        const snapshot = await getDocs(q);
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");
          li.innerHTML = `
            ${data.task}
            <button onclick="removeTask('${docSnap.id}')">åˆªé™¤</button>
          `;
          todoList.appendChild(li);
        });
      } catch (error) {
        console.error("Error loading tasks:", error);
      }
    }

    // 7. æ–°å¢ä»»åŠ¡ï¼ˆæ·»åŠ åˆ°æŒ‡å®šæ—¥æœŸçš„ "tasks" å­é›†åˆï¼‰
    async function addTask() {
      const selectedDate = dateSelect.value;
      const task = taskInput.value.trim();
      if (!task) return;

      try {
        const tasksCollection = collection(db, "dates", selectedDate, "tasks");
        await addDoc(tasksCollection, {
          task: task,
          timestamp: serverTimestamp()
        });
        taskInput.value = "";
        loadTasks(); // æ–°å¢ååˆ·æ–°ä»»åŠ¡åˆ—è¡¨
      } catch (error) {
        console.error("Error adding task:", error);
      }
    }

    // 8. åˆ é™¤ä»»åŠ¡ï¼ˆä»æŒ‡å®šæ—¥æœŸçš„ "tasks" å­é›†åˆä¸­åˆ é™¤ï¼‰
    // å› ä¸ºåœ¨ li ä¸­ä½¿ç”¨äº† onclick="removeTask('xxx')"
    // æ‰€ä»¥è¦æŠŠ removeTask æŒ‚è½½åˆ°å…¨å±€ï¼ˆwindowï¼‰å¯¹è±¡ä¸Š
    window.removeTask = async function(taskId) {
      const selectedDate = dateSelect.value;
      try {
        await deleteDoc(doc(db, "dates", selectedDate, "tasks", taskId));
        loadTasks();
      } catch (error) {
        console.error("Error removing task:", error);
      }
    };
  </script>

</body>
</html>
