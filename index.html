<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>二月 To-Do List (Firebase)</title>
  
  <!-- 外部样式表 -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>📅 2月 To-Do List (Firebase)</h1>
  
  <div class="todo-container">
    <label for="date">選擇日期：</label>
    <select id="date">
      <option value="feb26">2月26日</option>
      <option value="feb27">2月27日</option>
      <option value="feb28">2月28日</option>
    </select>
    
    <br><br>
    <input type="text" id="taskInput" placeholder="輸入待辦事項">
    <button id="addBtn">新增</button>
    
    <ul id="todoList"></ul>
  </div>

  <!-- 使用 ES Modules 的方式加载 Firebase SDK -->
  <script type="module">
    // 1. 导入 Firebase 所需模块
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    // 2. Firebase 配置（使用你自己的项目信息）
    const firebaseConfig = {
      apiKey: "AIzaSyBWZzgBQul9MWpVfp3jl4jwCee-DX1zb0s",
      authDomain: "temp-todo-list-7c25e.firebaseapp.com",
      projectId: "temp-todo-list-7c25e",
      storageBucket: "temp-todo-list-7c25e.firebasestorage.app",
      messagingSenderId: "388844458714",
      appId: "1:388844458714:web:5e9620d9d15c87458c0be3"
    };

    // 3. 初始化 Firebase 和 Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 4. 获取页面元素
    const dateSelect = document.getElementById("date");
    const taskInput = document.getElementById("taskInput");
    const addBtn = document.getElementById("addBtn");
    const todoList = document.getElementById("todoList");

    // 5. 页面加载后 & 日期切换时，加载对应日期的任务
    document.addEventListener("DOMContentLoaded", () => {
      dateSelect.addEventListener("change", loadTasks);
      addBtn.addEventListener("click", addTask);
      loadTasks(); // 默认加载当前下拉框选定日期的任务
    });

    // 6. 读取任务列表（从指定日期文档的 "tasks" 子集合）
    async function loadTasks() {
      const selectedDate = dateSelect.value;
      todoList.innerHTML = ""; // 清空列表

      // Firestore 路径：dates -> selectedDate -> tasks
      const tasksCollection = collection(db, "dates", selectedDate, "tasks");
      const q = query(tasksCollection, orderBy("timestamp", "asc"));

      try {
        const snapshot = await getDocs(q);
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");
          li.innerHTML = `
            ${data.task}
            <button onclick="removeTask('${docSnap.id}')">刪除</button>
          `;
          todoList.appendChild(li);
        });
      } catch (error) {
        console.error("Error loading tasks:", error);
      }
    }

    // 7. 新增任务（添加到指定日期的 "tasks" 子集合）
    async function addTask() {
      const selectedDate = dateSelect.value;
      const task = taskInput.value.trim();
      if (!task) return;

      try {
        const tasksCollection = collection(db, "dates", selectedDate, "tasks");
        await addDoc(tasksCollection, {
          task: task,
          timestamp: serverTimestamp()
        });
        taskInput.value = "";
        loadTasks(); // 新增后刷新任务列表
      } catch (error) {
        console.error("Error adding task:", error);
      }
    }

    // 8. 删除任务（从指定日期的 "tasks" 子集合中删除）
    // 因为在 li 中使用了 onclick="removeTask('xxx')"
    // 所以要把 removeTask 挂载到全局（window）对象上
    window.removeTask = async function(taskId) {
      const selectedDate = dateSelect.value;
      try {
        await deleteDoc(doc(db, "dates", selectedDate, "tasks", taskId));
        loadTasks();
      } catch (error) {
        console.error("Error removing task:", error);
      }
    };
  </script>

</body>
</html>
